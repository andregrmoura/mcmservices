<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects Dashboard | MCM Services</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="64x64" href="../favicon-64x64.png?v=3">
  <link rel="apple-touch-icon" href="../apple-touch-icon.png?v=3">
  <link rel="shortcut icon" href="../favicon.ico?v=3">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg:#F7F7F7;
      --card:#ffffff;
      --text:#333;
      --muted:#666;
      --muted2:#777;
      --border:#DDD;
      --border2:#EEE;
      --shadow: 0 4px 14px rgba(0,0,0,0.12);
      --shadow2: 0 10px 26px rgba(0,0,0,0.14);
      --gold:#C7A96B;
      --gold2:#b9965e;
      --header: rgba(0,0,0,0.4);
      --headerShadow: 0 5px 15px rgba(0,0,0,0.4);
      --barBg:#EFEFEF;
      --pillBg:#FAFAFA;
      --pillText:#222;
      --btnBg:#fff;
      --btnText:#222;
      --btnBorder: rgba(0,0,0,.10);
      --kpiHint:#777;
    }

    body.dark{
      --bg:#0d0f12;
      --card:#12161b;
      --text:#e9eef5;
      --muted:#aab3c0;
      --muted2:#9aa6b6;
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --shadow2: 0 16px 40px rgba(0,0,0,0.55);
      --header: rgba(0,0,0,0.55);
      --headerShadow: 0 14px 35px rgba(0,0,0,0.50);
      --barBg: rgba(255,255,255,0.10);
      --pillBg: rgba(255,255,255,0.06);
      --pillText:#e9eef5;
      --btnBg: rgba(255,255,255,0.04);
      --btnText:#e9eef5;
      --btnBorder: rgba(255,255,255,0.10);
      --kpiHint:#9aa6b6;
    }

    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      line-height:1.6;
      text-align:left;
    }
    a{ text-decoration:none; color:inherit; }

    /* HEADER (logo centralizada, sem links) */
    header{
      width:100%;
      background:var(--header);
      box-shadow:var(--headerShadow);
      position:absolute;
      top:0; left:0;
      z-index:100;
      padding:25px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .logo-link img{
      height:120px;
      max-width:320px;
      object-fit:contain;
    }

    main{
      min-height:80vh;
      padding:220px 20px 70px;
      display:block;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }

    h1{
      font-family:'Playfair Display',serif;
      color:var(--gold);
      font-weight:400;
      margin:0;
      font-size:3rem;
      margin-bottom:10px;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.95rem;
    }

    .top-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 16px;
    }
    .badge-line{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted2);
      font-size:.92rem;
    }
    .pill-mini{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--pillBg);
      color:var(--pillText);
      font-size:.86rem;
      font-weight:600;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--btnBg);
      color:var(--btnText);
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:.92rem;
    }
    body.dark .toggle{ box-shadow: 0 14px 26px rgba(0,0,0,0.45); }
    .toggle i{ color:var(--gold); }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
      margin: 10px 0 16px;
    }
    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px 16px 12px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .kpi::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:4px;
      background:var(--gold);
    }
    .kpi .label{
      font-size:.78rem;
      letter-spacing:.05em;
      color:var(--muted2);
      font-weight:700;
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .kpi .value{
      font-size:1.55rem;
      font-weight:700;
      color:var(--text);
      line-height:1.1;
    }
    .kpi .hint{
      margin-top:6px;
      font-size:.86rem;
      color:var(--kpiHint);
    }

    .tools{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin: 8px 0 18px;
    }
    .tools-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .input, .select{
      height:42px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:0 12px;
      outline:none;
      background:var(--card);
      color:var(--text);
      font-size:.95rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      min-width: 220px;
    }
    body.dark .input, body.dark .select{ box-shadow: 0 10px 26px rgba(0,0,0,0.45); }
    .select{ min-width:180px; text-align:center; }
    @media (max-width: 600px){
      .input, .select{ width:100%; min-width:unset; }
      .tools{ align-items:stretch; }
    }

    .section-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin: 10px 0 10px;
    }
    .section-title{
      font-size:1.25rem;
      color:var(--gold);
      font-family:'Playfair Display', serif;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 620px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 14px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }

    /* Card open overlay: reliable new-tab navigation (avoids popup blockers) */
    .card{ position: relative; }
    .card-open-link{
      position:absolute;
      inset:0;
      z-index: 1;
      border-radius: 26px; /* matches card radius */
    }
    /* Keep status editor controls above overlay */
    .status-pill{ position: relative; z-index: 2; }

    /* Keep meta links (e.g., Google Maps address) above the full-card link overlay */
    .meta{ position: relative; z-index: 2; }
    .meta a{ position: relative; z-index: 3; }
    .meta a:hover{ text-decoration: underline; }
    .card::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:4px;
      background:var(--gold);
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow:var(--shadow2);
      border-color: rgba(199,169,107,.55);
    }

    .topline{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .name{
      font-family:'Playfair Display',serif;
      color:var(--gold);
      font-size:1.45rem;
      font-weight:400;
      line-height:1.1;
      margin:0;
    }

    .right-stack{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--pillBg);
      font-size:.88rem;
      font-weight:600;
      white-space:nowrap;
      justify-content:flex-end;
      color:var(--pillText);
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background:#1DB954;
      box-shadow:0 0 0 3px rgba(29,185,84,.14);
    }
    .dot.planning{ background:#F4B400; box-shadow:0 0 0 3px rgba(244,180,0,.16); }
    .dot.completed{ background:#2E7D32; box-shadow:0 0 0 3px rgba(46,125,50,.16); }
    .dot.onhold{ background:#999; box-shadow:0 0 0 3px rgba(153,153,153,.14); }


    .dot.inactive{ background:#999; box-shadow:0 0 0 3px rgba(153,153,153,.14); }
    .dot.pending{ background:#F4B400; box-shadow:0 0 0 3px rgba(244,180,0,.16); }
    .tag-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted2);
      font-size:.82rem;
      font-weight:700;
      letter-spacing:.01em;
      white-space:nowrap;
    }
    .tag i{ color:var(--gold); }

    .tag.attn{
      border-color: rgba(244,180,0,.55);
      background: rgba(244,180,0,.10);
      color: var(--text);
    }
    .tag.pin{
      border-color: rgba(199,169,107,.60);
      background: rgba(199,169,107,.10);
      color: var(--text);
    }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      margin-top:6px;
      padding-top:10px;
      border-top:1px solid var(--border2);
    }
    .meta-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .meta-label{
      font-size:.75rem;
      letter-spacing:.05em;
      color:var(--muted2);
      font-weight:700;
      text-transform:uppercase;
    }
    .meta-value{
      font-size:.95rem;
      color:var(--text);
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .progress{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border2);
    }
    .progress-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background:var(--barBg);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background: linear-gradient(90deg, var(--c1, #22c55e), var(--c2, #f59e0b));
      transition:width .5s ease;
    }
    .pct{
      min-width:44px;
      text-align:right;
      font-weight:700;
      color:var(--text);
      font-size:.92rem;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:11px 14px;
      border-radius:12px;
      font-weight:600;
      font-size:.92rem;
      border:1px solid var(--btnBorder);
      background:var(--btnBg);
      color:var(--btnText);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease, border-color .12s ease;
    }
    body.dark .btn{ box-shadow: 0 14px 26px rgba(0,0,0,0.45); }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color: rgba(199,169,107,.55);
    }
    .btn.primary{
      background:var(--gold);
      border-color:var(--gold);
      color:#222;
    }
    .btn.primary:hover{ background:var(--gold2); color:#fff; }

    .loading, .empty, .error{
      margin-top:14px;
      padding:14px 16px;
      border-radius:14px;
      background:var(--card);
      color:var(--muted);
      border:1px solid var(--border);
      display:none;
    }
    .error{
      border-color: rgba(255,0,0,0.25);
      color: var(--text);
    }

    footer{
      background:white;
      padding:40px 20px;
      text-align:center;
      border-top:1px solid #DDD;
    }
    body.dark footer{
      background:#0b0d10;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .footer-logo-container{
      display:block;
      margin:0 auto 15px;
      text-align:center;
    }
    .footer-logo-container img{
      height:60px;
      width:180px;
      object-fit:contain;
    }
    .footer-content-grid{
      max-width:1200px;
      margin:0 auto 30px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      text-align:left;
      gap:30px;
      flex-wrap:wrap;
    }
    .footer-col{
      display:flex;
      flex-direction:column;
      min-width:150px;
      padding:0 10px;
      align-items:flex-start;
    }
    .footer-col h4{
      font-size:1rem;
      font-weight:600;
      color:var(--text);
      margin-top:0;
      margin-bottom:15px;
      border-bottom:2px solid var(--gold);
      padding-bottom:5px;
      text-align:left;
    }
    .footer-col a{
      color:var(--muted);
      font-size:0.9rem;
      font-weight:400;
      padding:5px 0;
      transition:color 0.3s;
      display:block;
    }
    .footer-col a:hover{ color:var(--gold); }
    .footer-social-contact a{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      justify-content:center;
    }
    .footer-social-contact i{
      color:var(--gold);
      font-size:1rem;
    }
    .footer-bottom-line{
      padding-top:20px;
      border-top:1px solid rgba(0,0,0,0.06);
      color:var(--muted2);
      font-size:0.85rem;
      text-align:center;
    }
    body.dark .footer-bottom-line{
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .footer-bottom-line p{ margin:5px 0; }
    .footer-bottom-line .copyright{
      font-size:0.9rem;
      color:var(--muted);
      line-height:1.6;
      letter-spacing:0.3px;
    }
    .footer-bottom-line strong{ font-weight:500; color:var(--text); }
    .powered-by{
      font-size:0.75rem;
      color:var(--muted2);
      letter-spacing:0.6px;
      display:inline-block;
      margin-top:4px;
    }
  
/* Legend */
.dashboard-legend{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  margin: 10px 0 18px;
  font-size: 13px;
  color: var(--muted);
}
.legend-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--card);
  box-shadow: var(--shadow-sm);
}
.legend-dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display:inline-block;
}
.legend-item.planning .legend-dot{ background: #f59e0b; }
.legend-item.active .legend-dot{ background: #10b981; }
.legend-item.completed .legend-dot{ background: #3b82f6; }
.legend-item.hold .legend-dot{ background: #ef4444; }

    /* Dashboard enhancements: clickable cards + status editor (admin only) */
    .card.is-clickable { cursor: pointer; }
    .card.is-clickable:focus-within { outline: 2px solid rgba(199,169,107,0.45); outline-offset: 2px; }

    .status-pill{ display:inline-flex; align-items:center; gap:10px; }
    .status-pill .status-edit{
      border:1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--btnText);
      width:28px;
      height:28px;
      border-radius:999px;
      display:inline-flex;
      align-items:center;
      justify-content:center;
      cursor:pointer;
      padding:0;
    }
    .status-pill .status-edit:hover{ border-color: rgba(199,169,107,0.55); }

    .status-menu{
      position:fixed;
      z-index:99999;
      background: var(--card);
      border: 1px solid var(--border);
      box-shadow: var(--shadow2);
      border-radius: 14px;
      padding: 14px;
      width: min(340px, calc(100vw - 24px));
      max-height: calc(100vh - 24px);
      overflow: auto;
    }
    .status-menu h4{ margin:0 0 10px; font-size:14px; color: var(--text); }
    .status-menu .row{ display:flex; gap:10px; align-items:center; }
    .status-menu select{
      flex:1;
      padding:10px 12px;
      border-radius:10px;
      border:1px solid var(--border);
      background: var(--pillBg);
      color: var(--text);
      font-family: inherit;
      font-size: 14px;
    }
    .status-menu .btnrow{ display:flex; gap:10px; margin-top:12px; justify-content:flex-end; }
    .status-menu .btnx{
      padding:10px 12px;
      border-radius: 12px;
      border: 1px solid var(--btnBorder);
      background: var(--btnBg);
      color: var(--btnText);
      cursor:pointer;
      font-weight:600;
      font-size: 13px;
    }
    .status-menu .btnx.primary{
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color:#111;
      border-color: rgba(0,0,0,0.12);
    }
    .status-menu .hint{ margin-top:10px; font-size:12px; color: var(--muted); line-height:1.35; }

  
    /* Auth overlay (professional login) */
    body.locked{ overflow:hidden; }
    body.locked header,
    body.locked main,
    body.locked footer{ display:none; }

    .auth-overlay{
      position:fixed;
      inset:0;
      z-index:999999;
      display:flex;
      align-items:center;
      justify-content:center;
      padding:24px;
      background:
        radial-gradient(1200px 700px at 50% 20%, rgba(199,169,107,0.24), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,0.55), rgba(0,0,0,0.30));
      backdrop-filter: blur(10px);
    }
    body.dark .auth-overlay{
      background:
        radial-gradient(1200px 700px at 50% 20%, rgba(199,169,107,0.20), rgba(0,0,0,0) 60%),
        linear-gradient(180deg, rgba(0,0,0,0.70), rgba(0,0,0,0.45));
    }

    .auth-card{
      width:min(520px, 100%);
      background: var(--card);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .auth-top{
      padding:22px 22px 0;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .auth-top img{
      height:86px;
      width:auto;
      max-width:280px;
      object-fit:contain;
    }
    .auth-body{
      padding: 12px 22px 22px;
      text-align:center;
    }
    .auth-title{
      font-family:'Playfair Display', serif;
      color: var(--gold);
      font-weight:400;
      font-size: 1.85rem;
      margin: 6px 0 6px;
    }
    .auth-sub{
      margin: 0 0 16px;
      color: var(--muted);
      font-size: .95rem;
      line-height:1.5;
    }
    .auth-form{
      display:flex;
      flex-direction:column;
      gap:10px;
      align-items:stretch;
      margin-top:10px;
    }
    .auth-field{
      display:flex;
      align-items:center;
      gap:10px;
      border:1px solid var(--border);
      border-radius:14px;
      padding: 12px 12px;
      background: var(--btnBg);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
    }
    body.dark .auth-field{ box-shadow: 0 14px 26px rgba(0,0,0,0.45); }
    .auth-field i{ color: var(--gold); }
    .auth-input{
      border:none;
      outline:none;
      background:transparent;
      color: var(--text);
      font-size: 1rem;
      width:100%;
      font-family: inherit;
    }
    .auth-eye{
      border:none;
      background:transparent;
      color: var(--muted2);
      cursor:pointer;
      padding:6px 8px;
      border-radius:10px;
    }
    .auth-eye:hover{ background: rgba(199,169,107,0.12); color: var(--text); }

    .auth-btn{
      display:inline-flex;
      justify-content:center;
      align-items:center;
      gap:10px;
      padding: 12px 14px;
      border-radius:14px;
      border:1px solid rgba(0,0,0,0.10);
      background: linear-gradient(180deg, var(--gold), var(--gold2));
      color:#111;
      font-weight:700;
      cursor:pointer;
      box-shadow: 0 10px 22px rgba(0,0,0,0.12);
      transition: transform .12s ease, box-shadow .12s ease, filter .12s ease;
    }
    .auth-btn:hover{
      transform: translateY(-1px);
      box-shadow: 0 14px 28px rgba(0,0,0,0.16);
      filter: brightness(1.02);
    }
    .auth-msg{
      display:none;
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 12px;
      border: 1px solid rgba(255,0,0,0.22);
      background: rgba(255,0,0,0.06);
      color: var(--text);
      font-size: .92rem;
    }
    .auth-foot{
      margin-top:14px;
      font-size:.82rem;
      color: var(--muted2);
    }
    .auth-foot strong{ color: var(--text); font-weight:600; }

    @keyframes authShake{
      0%,100%{ transform: translateX(0); }
      20%{ transform: translateX(-6px); }
      40%{ transform: translateX(6px); }
      60%{ transform: translateX(-4px); }
      80%{ transform: translateX(4px); }
    }
    .auth-card.shake{ animation: authShake .28s ease; }

  
/* ICON CLEANUP */
.status-edit{ display:none !important; }
.dot{ width:8px; height:8px; border-radius:50%; display:inline-block; margin-right:6px; }
.tag.attn::before, .tag.pin::before, .toggle::before{ content:none !important; display:none !important; }

    /* Weather gadget */
    .weather-gadget{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:6px;
      text-align:right;
      min-width: 220px;
    }
    .weather-pill{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:14px;
      border:1px solid var(--border);
      background:var(--card);
      box-shadow: var(--shadow);
      color:var(--text);
      font-weight:700;
      font-size:.95rem;
      line-height:1;
      white-space:nowrap;
    }
    .weather-pill i{ color: var(--gold); }
    @media (max-width: 620px){
      .weather-gadget{
        align-items:flex-start;
        text-align:left;
        min-width: unset;
      }
    }


    /* === Mobile fix: allow Address (Google Maps) link above full-card overlay === */
    .card-open-link{
      position:absolute;
      inset:0;
      z-index:1;
    }
    .meta{
      position:relative;
      z-index:2;
    }
    .meta a{
      position:relative;
      z-index:3;
      pointer-events:auto;
      display:inline-flex;
      align-items:center;
      padding:4px 0;
    }

</style>
</head>

<body class="locked">

  <!-- Auth overlay -->
  <div id="authOverlay" class="auth-overlay" role="dialog" aria-modal="true" aria-label="Dashboard login">
    <div class="auth-card" id="authCard">
      <div class="auth-top">
        <img src="../images/transparent-logo-2.png" alt="MCM Services Logo">
      </div>
      <div class="auth-body">
        <div class="auth-title">Projects Dashboard</div>
        <p class="auth-sub">Private access for internal use. Please enter the access password to continue.</p>

        <form class="auth-form" id="authForm" autocomplete="off">
          <div class="auth-field">
            
            <input class="auth-input" id="authPassword" type="password" inputmode="text" placeholder="Access password" aria-label="Access password" required>
            <button class="auth-eye" type="button" id="authToggle" aria-label="Show password">
              
            </button>
          </div>

          <button class="auth-btn" type="submit">
            
            Enter Dashboard
          </button>
        </form>

        <div class="auth-msg" id="authMsg" role="alert">Incorrect password. Please try again.</div>
        <div class="auth-foot">Tip: Access is shared only with authorized team members.</div>
      </div>
    </div>
  </div>

  <noscript>
    <div style="font-family:Montserrat, sans-serif; padding:18px; text-align:center;">
      This dashboard requires JavaScript to display the login screen and load project data.
    </div>
  </noscript>



<!-- BASIC PASSWORD (single sign-on for dashboard) -->
<script>
  // Storage keys (persistent login)
  const ACCESS_KEY_STORAGE = "mcm_dash_admin_key";
  const ACCESS_OK_STORAGE  = "mcm_dash_unlocked";

  function setAuthLoading(isLoading){
    const btn = document.querySelector("#authForm .auth-btn");
    const input = document.getElementById("authPassword");
    if (btn) btn.disabled = !!isLoading;
    if (input) input.disabled = !!isLoading;
  }

  function hideAuthError(){
    const m = document.getElementById("authMsg");
    if (m) m.style.display = "none";
  }

  function showAuthError(msg){
    const m = document.getElementById("authMsg");
    const card = document.getElementById("authCard");
    if (m){
      m.textContent = msg || "Incorrect password. Please try again.";
      m.style.display = "block";
    }
    if (card){
      card.classList.remove("shake");
      void card.offsetWidth; // restart animation
      card.classList.add("shake");
    }
  }

  async function verifyAdminKey(key){
    const r = await fetch("/.netlify/functions/get-portal-leads?limit=1", {
      headers: { "x-admin-key": key }
    });
    return r.ok;
  }

  function unlockDashboard(key){
    const k = String(key || "").trim();
    if (!k){
      showAuthError("Please enter your access password.");
      return;
    }

    setAuthLoading(true);
    hideAuthError();

    verifyAdminKey(k)
      .then((ok) => {
        if (!ok){
          setAuthLoading(false);
          showAuthError("Incorrect password. Please try again.");
          const pwd = document.getElementById("authPassword");
          if (pwd) pwd.select();
          return;
        }

        // Persist (one login for everything)
        try{
          localStorage.setItem(ACCESS_KEY_STORAGE, k);
          localStorage.setItem(ACCESS_OK_STORAGE, "1");
        }catch{}

        // Unlock UI
        document.body.classList.remove("locked");
        const overlay = document.getElementById("authOverlay");
        if (overlay) overlay.style.display = "none";

        setAuthLoading(false);

        // Load data (projects + leads)
        try{ loadAll?.(); }catch{}
        try{ loadLeads?.(); }catch{}
      })
      .catch((err) => {
        console.error(err);
        setAuthLoading(false);
        showAuthError("Could not verify right now. Please try again.");
      });
  }

  function getAdminKey(){
    try { return (localStorage.getItem(ACCESS_KEY_STORAGE) || "").trim(); }
    catch { return ""; }
  }

  // Expose for debugging
  window.unlockDashboard = unlockDashboard;
  window.getAdminKey = getAdminKey;

  function initAuth(){
    const form = document.getElementById("authForm");
    const pwd = document.getElementById("authPassword");
    const toggle = document.getElementById("authToggle");

    // Auto-unlock if previously saved
    try{
      const ok = localStorage.getItem(ACCESS_OK_STORAGE) === "1";
      const key = (localStorage.getItem(ACCESS_KEY_STORAGE) || "").trim();
      if (ok && key){
        unlockDashboard(key);
        return;
      }
    }catch{}

    if (toggle && pwd){
      // Ensure icon exists
      if (!toggle.querySelector("i")){
        toggle.innerHTML = '<i class="fa-regular fa-eye"></i>';
      }
      toggle.addEventListener("click", () => {
        const isPwd = (pwd.getAttribute("type") || "password") === "password";
        pwd.setAttribute("type", isPwd ? "text" : "password");
        toggle.setAttribute("aria-label", isPwd ? "Hide password" : "Show password");
        const icon = toggle.querySelector("i");
        if (icon) icon.className = isPwd ? "fa-regular fa-eye-slash" : "fa-regular fa-eye";
        pwd.focus();
      });
    }

    if (!form || !pwd) return;

    setTimeout(() => pwd.focus(), 50);

    form.addEventListener("submit", (e) => {
      e.preventDefault();
      unlockDashboard(pwd.value);
    });
  }

  initAuth();
</script>


<header>
  <a class="logo-link" href="../index.html">
    <img src="../images/FODA.png" alt="MCM Services Logo">
  </a>
</header>

<main>
  <div class="wrap">
    <h1>Projects Dashboard</h1>
    

    <div class="top-actions">
      </div>

    <div class="kpi-row" aria-label="KPIs">
      <div class="kpi">
        <div class="label">Total</div>
        <div class="value" id="kpiTotal">0</div>
        
      </div>
      <div class="kpi">
        <div class="label">Active</div>
        <div class="value" id="kpiActive">0</div>
        
      </div>
      <div class="kpi">
        <div class="label">Completed</div>
        <div class="value" id="kpiCompleted">0</div>
        
      </div>
      <div class="kpi">
        <div class="label">Needs Attention</div>
        <div class="value" id="kpiAttention">0</div>
        
      </div>
    </div>

    <div class="tools" aria-label="Tools">
      <div class="tools-left">
        <input id="q" class="input" type="search" placeholder="Search by name / slug..." autocomplete="off" />
        <select id="status" class="select" aria-label="Filter by status">
          <option value="all">All statuses</option>
          <option value="" disabled selected>Loading…</option>
        </select>
        <select id="city" class="select" aria-label="Filter by city/area">
          <option value="all">All areas</option>
        </select>
      </div>
    </div>

    <div class="section-row">
      <div class="section-title">Portfolio</div>
      <div class="weather-gadget" aria-label="Weather and refresh">
        <div class="weather-pill" id="weatherPill" title="Live weather for Miami, FL">
          <i class="fa-solid fa-cloud-sun" aria-hidden="true"></i>
          <span id="weatherTemp">—</span>
          <span style="font-weight:600; color:var(--muted2);">|</span>
          <span id="weatherDesc" style="font-weight:600; color:var(--muted2);">Loading weather…</span>
        </div>
        <div style="color:var(--muted2); font-weight:600; font-size:.92rem;">
          Last refresh: <span id="refTime">—</span>
        </div>
      </div>
    </div>

    <div id="loading" class="loading">Loading dashboard.json + project.json files...</div>
    <div id="error" class="error"></div>
    <section id="grid" class="grid" aria-label="Project cards"></section>
    <div id="empty" class="empty"></div>
  
    <!-- Leads -->
    <div class="section-row" style="margin-top:22px;">
      <div class="section-title">Leads</div>

      <div class="tools-left" style="justify-content:flex-end;">
        <input id="leadQuery" class="input" type="search" placeholder="Search name / email / project…" autocomplete="off" style="min-width:240px;">
        <input id="leadProject" class="input" type="search" placeholder="Filter projectSlug (optional)" autocomplete="off" style="min-width:220px;">
        <button id="refreshLeads" class="btn" type="button"><i class="fa-solid fa-rotate" aria-hidden="true"></i> Refresh</button>
      </div>
    </div>

    <div id="leadsBox" class="card" style="padding:16px; margin-bottom:18px;">
      <div class="meta-label" style="margin-bottom:10px;">Latest leads</div>
      <div id="leadsState" class="sub" style="margin:0 0 10px; display:none;"></div>
      <div id="leadsList"></div>
    </div>

</div>
</main>

<footer>
  <div class="footer-logo-container">
    <img alt="MCM Services Logo Footer" src="../images/transparent-logo-2.png" />
  </div>

  <p style="color:var(--muted); font-size:.95rem; margin-bottom:15px;">
    Management Excellence, Flawless Execution.
  </p>

  <p style="color:var(--muted); font-size:.9rem; margin-bottom:30px;">
    
    Miami, FL
  </p>

  <div class="footer-content-grid">
    <div class="footer-col">
      <h4>Navigation</h4>
      <a href="../">Home</a>
      <a href="../#about">About</a>
      <a href="../#contact">Contact</a>
    </div>

    <div class="footer-col footer-social-contact">
      <h4>Contact &amp; Connect</h4>
      <a href="tel:+17862383386"> +1 (786) 238-3386</a>
      <a href="mailto:info@mcmprosolutions.com"> info@mcmprosolutions.com</a>
      <a href="https://www.instagram.com/mcmservices.us" target="_blank" rel="noopener">
         @mcmservices.us
      </a>
    </div>

    <div class="footer-col">
      <h4>Legal</h4>
      <a href="../terms.html">Terms of Use</a>
      <a href="../privacy.html">Privacy Policy</a>
    </div>
  </div>

  <div class="footer-bottom-line">
    <p class="copyright">
      © <span id="year"></span>
      <strong>MCM Services USA Corporation</strong>. All rights reserved.<br />
      <span class="powered-by">Crafted &amp; Managed by mcmprosolutions.com</span>
    </p>
  </div>
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  document.getElementById('refTime').textContent = new Date().toLocaleString();
  
  // ===== Weather gadget (Miami, FL) =====
  // Uses Open-Meteo (no API key). Change lat/lon if you want another city.
  const WEATHER = {
    lat: 25.7617,
    lon: -80.1918,
    tz: "America/New_York",
    cacheKey: "mcm_dash_weather_cache_v1",
    cacheTtlMs: 20 * 60 * 1000 // 20 min
  };

  function weatherCodeToText(code){
    const c = Number(code);
    if (isNaN(c)) return "—";
    if (c === 0) return "Clear";
    if (c === 1 || c === 2) return "Partly cloudy";
    if (c === 3) return "Overcast";
    if (c === 45 || c === 48) return "Fog";
    if (c === 51 || c === 53 || c === 55) return "Drizzle";
    if (c === 56 || c === 57) return "Freezing drizzle";
    if (c === 61 || c === 63 || c === 65) return "Rain";
    if (c === 66 || c === 67) return "Freezing rain";
    if (c === 71 || c === 73 || c === 75) return "Snow";
    if (c === 77) return "Snow grains";
    if (c === 80 || c === 81 || c === 82) return "Showers";
    if (c === 85 || c === 86) return "Snow showers";
    if (c === 95) return "Thunderstorm";
    if (c === 96 || c === 99) return "Storm + hail";
    return "Weather";
  }

  function setWeatherUI(tempF, code){
    const tEl = document.getElementById("weatherTemp");
    const dEl = document.getElementById("weatherDesc");
    if (!tEl || !dEl) return;
    const t = (typeof tempF === "number" && isFinite(tempF)) ? `${Math.round(tempF)}°F` : "—";
    tEl.textContent = t;
    dEl.textContent = weatherCodeToText(code);
  }

  async function loadWeather(){
    try{
      const now = Date.now();
      const cachedRaw = localStorage.getItem(WEATHER.cacheKey);
      if (cachedRaw){
        try{
          const cached = JSON.parse(cachedRaw);
          if (cached && (now - cached.ts) < WEATHER.cacheTtlMs){
            setWeatherUI(cached.tempF, cached.code);
            return;
          }
        }catch{}
      }

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER.lat}&longitude=${WEATHER.lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=${encodeURIComponent(WEATHER.tz)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Weather HTTP ${res.status}`);
      const data = await res.json();
      const tempF = data?.current?.temperature_2m;
      const code = data?.current?.weather_code;
      setWeatherUI(tempF, code);
      try{ localStorage.setItem(WEATHER.cacheKey, JSON.stringify({ ts: now, tempF, code })); }catch{}
    }catch(err){
      const dEl = document.getElementById("weatherDesc");
      if (dEl) dEl.textContent = "Weather unavailable";
    }
  }

  loadWeather();
  setInterval(loadWeather, WEATHER.cacheTtlMs);


  // CONFIG (AUTO ROOT - works in any folder and on www/non-www)
const PROJECTS_ROOT_URL = new URL("./", window.location.href); // folder containing this index.html
const PROJECTS_ROOT = PROJECTS_ROOT_URL.pathname.endsWith("/") ? PROJECTS_ROOT_URL.pathname : (PROJECTS_ROOT_URL.pathname + "/");
const DASHBOARD_JSON_URL = new URL("dashboard.json", PROJECTS_ROOT_URL).href;
const BASE_PROJECTS_URL = PROJECTS_ROOT; // project portals under this same folder

  let ATTENTION_DAYS = 14;

  // UI
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");
  const loading = document.getElementById("loading");
  const errorBox = document.getElementById("error");

  const q = document.getElementById("q");
  const statusSel = document.getElementById("status");
  const citySel = document.getElementById("city");

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function dotClass(status){
    const s = (status||"").toLowerCase().trim();

    // normalize common variants
    if (s === "completed") return "completed";
    if (s === "planning") return "planning";
    if (s === "on hold" || s === "onhold") return "onhold";

    // insurance / secondary statuses
    if (s.includes("inactive") || s.includes("expired") || s.includes("cancel") || s.includes("suspend")) return "inactive";
    if (s.includes("pending") || s.includes("await") || s.includes("review") || s.includes("approval") || s.includes("deposit") || s.includes("payment")) return "pending";

    // default (active/ok) keeps green
    return "";
  }
  function parseDateLoose(s){
    // Accept "Feb 04, 2026" and ignore placeholders like "MMM DD, YYYY"
    const str = String(s || "").trim();
    if (!str || str.toLowerCase().includes("mmm") || str.toLowerCase().includes("yyyy")) return null;
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
  }

  function daysAgo(dateObj){
    const now = new Date();
    const ms = now.getTime() - dateObj.getTime();
    return Math.floor(ms / (1000 * 60 * 60 * 24));
  }

  
function statusKey(status){
  const s = (status||"").toLowerCase().trim();
  if (s.includes("complete")) return "completed";
  if (s.includes("inactive")) return "inactive";
  if (s.includes("pending")) return "pending";
  if (s.includes("in progress")) return "inprogress";
  if (s.includes("active")) return "active";
  return "pending";
}

const STATUS_FLOW = ["pending","active","inprogress","completed"];

const STATUS_COLOR = {
  pending:   "#f59e0b", // amarelo/laranja
  active:    "#22c55e", // verde
  inprogress:"#84cc16", // verde intermediário
  completed: "#477c3d", // verde do status (match)
  inactive:  "#9ca3af"  // cinza
};

function nextStatusKey(key){
  const i = STATUS_FLOW.indexOf(key);
  if (i < 0) return key; // fora do fluxo -> sólido
  if (i === STATUS_FLOW.length - 1) return key; // último -> sólido
  return STATUS_FLOW[i + 1];
}

function progressGradientForStatus(status){
  const k1 = statusKey(status);
  // Inactive (ou qualquer fora do fluxo) fica sólido
  if (k1 === "inactive") {
    return { c1: STATUS_COLOR.inactive, c2: STATUS_COLOR.inactive };
  }
  const k2 = nextStatusKey(k1);
  const c1 = STATUS_COLOR[k1] || "#22c55e";
  const c2 = STATUS_COLOR[k2] || c1; // se for último -> sólido
  return { c1, c2 };
}

function statusToProgress(status){
    const s = (status||"").toLowerCase().trim();
    if (s === "completed") return 100;
    if (s === "active") return 40;
    if (s === "planning") return 10;
    if (s === "on hold" || s === "onhold") return 0;
    return 0;
  }

  function normalizeInsurance(s){
    return String(s || "").trim(); // "Active" | "Pending" | "Inactive" etc.
  }

  function needsAttention(p){
    const ins = (p.insuranceStatus || "").toLowerCase().trim();
    if (ins && ins !== "active") return true; // Pending/Inactive/etc => attention

    const isActive = (p.status || "").toLowerCase().trim() === "active";
    const d = parseDateLoose(p.lastUpdate || "");
    if (isActive){
      if (!d) return true; // Active but missing a real date
      return daysAgo(d) > ATTENTION_DAYS;
    }
    return false;
  }

  function cityFromAddress(addr){
    // "Street, City, State ZIP" => returns City
    const parts = String(addr || "").split(",").map(s => s.trim()).filter(Boolean);
    if (parts.length >= 2) return parts[parts.length - 2];
    return "";
  }

  function buildCityOptions(projects){
    const cities = Array.from(new Set(
      projects.map(p => (p.city || "").trim()).filter(Boolean)
    )).sort((a,b) => a.localeCompare(b));

    const current = citySel.value || "all";
    citySel.innerHTML =
      `<option value="all">All areas</option>` +
      cities.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");

    if ([...citySel.options].some(o => o.value === current)) citySel.value = current;
  }

  function kpis(projects){
    const total = projects.length;
    const active = projects.filter(p => p.status === "Active").length;
    const completed = projects.filter(p => p.status === "Completed").length;
    const attention = projects.filter(needsAttention).length;

    document.getElementById("kpiTotal").textContent = total;
    document.getElementById("kpiActive").textContent = active;
    document.getElementById("kpiCompleted").textContent = completed;
    document.getElementById("kpiAttention").textContent = attention;
  }
function sortProjects(projects){
  const statusRank = (s) => {
    const x = (s||"").toLowerCase().trim();

    // 1) Active first (including "in progress")
    if (x === "active" || x.includes("in progress")) return 1;

    // 2) Pending second (Planning / Pending / Awaiting / Approval etc.)
    if (x === "planning" || x.includes("pending") || x.includes("await") || x.includes("review") || x.includes("approval")) return 2;

    // 3) Completed third
    if (x === "completed" || x.includes("complete")) return 3;

    // 4) Inactive last (Inactive / On Hold / Expired / Cancelled / Suspended)
    if (x.includes("inactive") || x.includes("on hold") || x.includes("onhold") || x.includes("expired") || x.includes("cancel") || x.includes("suspend")) return 4;

    return 9;
  };

  // Sort by your requested status priority first, then pinned, then needs-attention, then lastUpdate (newest first)
  
const statusSubRank = (s) => {
  const x = (s||"").toLowerCase().trim();
  // within Active group, show "In progress" before "Active"
  if (x.includes("in progress")) return 1;
  if (x === "active") return 2;
  return 9;
};
    return projects.slice().sort((a,b) => {
    const sr = statusRank(a.status) - statusRank(b.status);
    if (sr !== 0) return sr;

    const ssr = statusSubRank(a.status) - statusSubRank(b.status);
    if (ssr !== 0) return ssr;

    const ap = !!a.pinned, bp = !!b.pinned;
    if (ap !== bp) return ap ? -1 : 1;

    const aa = needsAttention(a), ba = needsAttention(b);
    if (aa !== ba) return aa ? -1 : 1;

    return new Date(b.lastUpdate || 0) - new Date(a.lastUpdate || 0);
  });
}

  function render(projects){
    const query = (q.value || "").trim().toLowerCase();
    const st = statusSel.value;
    const city = citySel.value;

    const filtered = sortProjects(projects).filter(p => {
      const matchQ = !query ||
        (p.name||"").toLowerCase().includes(query) ||
        (p.slug||"").toLowerCase().includes(query);

      const matchS = (st === "all") || (p.status === st);
      const matchC = (city === "all") || ((p.city||"") === city);

      return matchQ && matchS && matchC;
    });

    kpis(projects);

    grid.innerHTML = filtered.map(p => {
      const slug = String(p.slug || "").replace(/^\/+|\/+$/g, "");
      const projectUrl = `${BASE_PROJECTS_URL}${slug}/`;

      const pct = Math.max(0, Math.min(100, Number(p.progress ?? 0)));
      const dClass = dotClass(p.status);
      const attn = needsAttention(p);

      const attnReason = (() => {
        const ins = normalizeInsurance(p.insuranceStatus);
        if (ins && ins !== "Active") return `Insurance: ${ins}`;
        const d = parseDateLoose(p.lastUpdate || "");
        if ((p.status||"").toLowerCase().trim() === "active"){
          if (!d) return "Missing last update";
          const da = daysAgo(d);
          if (da > ATTENTION_DAYS) return `No update in ${da}d`;
        }
        return "";
      })();

      return `
        <article class="card is-clickable" data-project-url="${projectUrl}" data-slug="${slug}">
          <a class="card-open-link" href="${projectUrl}" target="_blank" rel="noopener noreferrer" aria-label="Open project"></a>
          <div class="topline">
            <h3 class="name">${esc(p.name)}</h3>

            <div class="right-stack">
              <span class="status-pill" data-action="status-menu" data-slug="${slug}"> <span class="dot ${dClass}" aria-hidden="true"></span>
                 <span class="status-text">${esc(p.status)}</span> </span>

              <div class="tag-row">
                ${p.pinned ? `<span class="tag pin"> Pinned</span>` : ``}
                ${p.city ? `<span class="tag"> ${esc(p.city)}</span>` : ``}
                ${attn ? `<span class="tag attn"> Needs Attention</span>` : ``}
              </div>
            </div>
          </div>

          <div class="meta">
            <div class="meta-item">
              <span class="meta-label">Last update</span>
              <span class="meta-value">${esc(p.lastUpdate || "-")}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Insurance</span>
              <span class="meta-value">${esc(p.insuranceStatus || "—")}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Address</span>
              <span class="meta-value">
                ${p.projectAddress 
                  ? `<a href="https://www.google.com/maps/search/?api=1&query=${encodeURIComponent(p.projectAddress)}" target="_blank" rel="noopener noreferrer">
                       <i class="fa-solid fa-location-dot" style="margin-right:6px; color:var(--gold);"></i>
                       ${esc(p.projectAddress)}
                     </a>`
                  : "—"}
              </span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Attention</span>
              <span class="meta-value">${esc(attn ? (attnReason || "Review") : "OK")}</span>
            </div>
          </div>

          <div class="progress">
            <div class="meta-label" style="margin-bottom:8px;">Progress</div>
            <div class="progress-row">
              ${(() => { const eng = window.__statusEngine; if (eng && typeof eng.getProgressBarBackground === "function") { const bg = eng.getProgressBarBackground(p.status); return `<div class="bar"><div class="fill" style="width:${pct}%; background:${bg};"></div></div>`; } const g = progressGradientForStatus(p.status); return `<div class="bar"><div class="fill" style="width:${pct}%; --c1:${g.c1}; --c2:${g.c2};"></div></div>`; })()}
              <div class="pct">${pct}%</div>
            </div>
          </div>
        </article>
      `;
    }).join("");

    if (!filtered.length){
      empty.style.display = "block";
      empty.textContent = "No projects match your filters.";
    } else {
      empty.style.display = "none";
      empty.textContent = "";
    }
  }
  // ---- Admin actions (status update) + clickable cards (no Open Project button) ----
  let ALL_PROJECTS = [];
  let STATUS_OPTIONS = [];
  const DEFAULT_STATUS_OPTIONS = [
    "Planning",
    "Active",
    "In Progress",
    "Approved",
    "Scheduled",
    "Confirmed",
    "Pending",
    "Awaiting",
    "Review",
    "Approval",
    "Deposit",
    "Payment",
    "On Hold",
    "Inactive",
    "Expired",
    "Cancelled",
    "Canceled",
    "Suspended",
    "Completed"
  ];

  // ===== Leads (Supabase) =====
  function formatDate(dt){
    try { return new Date(dt).toLocaleString(); } catch { return ""; }
  }

  function setLeadsState(msg){
    const el = document.getElementById("leadsState");
    if (!el) return;
    if (!msg){ el.style.display = "none"; el.textContent = ""; return; }
    el.style.display = "block";
    el.textContent = msg;
  }

  function renderLeads(rows){
    const wrap = document.getElementById("leadsList");
    if (!wrap) return;

    if (!Array.isArray(rows) || !rows.length){
      wrap.innerHTML = `<div class="sub" style="margin:0;">No leads yet.</div>`;
      return;
    }

    wrap.innerHTML = rows.map(r => {
      const name = escapeHtml(r.full_name || "-");
      const email = escapeHtml(r.email || "-");
      const phone = escapeHtml(r.phone || "");
      const slug = escapeHtml(r.project_slug || "-");
      const when = r.created_at ? formatDate(r.created_at) : "";

      return `
        <div style="display:flex; justify-content:space-between; gap:12px; padding:10px 0; border-top:1px solid var(--border2);">
          <div style="min-width:0;">
            <div style="font-weight:700; color:var(--text);">${name}</div>
            <div class="sub" style="margin:2px 0 0;">
              ${email}${phone ? ` • ${phone}` : ""} • <strong>${slug}</strong>
            </div>
          </div>
          <div class="sub" style="white-space:nowrap; margin:0;">${escapeHtml(when)}</div>
        </div>
      `;
    }).join("");
  }

  async function loadLeads(){
    const adminKey = getAdminKey();
    if (!adminKey){
      setLeadsState("Unlock the dashboard to view leads.");
      renderLeads([]);
      return;
    }

    const q = (document.getElementById("leadQuery")?.value || "").trim();
    const projectSlug = (document.getElementById("leadProject")?.value || "").trim();

    const params = new URLSearchParams();
    params.set("limit", "100");
    if (q) params.set("q", q);
    if (projectSlug) params.set("projectSlug", projectSlug);

    setLeadsState("Loading leads…");

    const res = await fetch(`/.netlify/functions/get-portal-leads?${params.toString()}`, {
      headers: { "x-admin-key": adminKey }
    });

    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!res.ok || data.ok === false){
      setLeadsState(data?.error || data?.details || data?.raw || `HTTP ${res.status}`);
      renderLeads([]);
      return;
    }

    setLeadsState("");
    renderLeads(data.data || []);
  }

  function initLeadsUI(){
    document.getElementById("refreshLeads")?.addEventListener("click", loadLeads);

    document.getElementById("leadQuery")?.addEventListener("input", () => {
      clearTimeout(window.__leadT);
      window.__leadT = setTimeout(loadLeads, 300);
    });

    document.getElementById("leadProject")?.addEventListener("change", loadLeads);
  }
async function updateStatusViaFunction(slug, nextStatus){
    const adminKey = getAdminKey();
    if (!adminKey) throw new Error("Missing admin key.");

    const res = await fetch("/.netlify/functions/updateProjectStatus", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "x-admin-key": adminKey
      },
      body: JSON.stringify({
        slug,
        projectStatus: nextStatus,
        projectStatusSub: ""
      })
    });

    const text = await res.text();
    let data = {};
    try { data = JSON.parse(text); } catch { data = { raw: text }; }

    if (!res.ok || data.ok === false){
      const msg = data?.error || data?.details || data?.raw || `HTTP ${res.status}`;
      throw new Error(msg);
    }
    return data;
  }

  function closeStatusMenu(){
    const m = document.getElementById("statusMenu");
    if (m) m.remove();
    document.removeEventListener("keydown", onStatusMenuEsc, true);
    document.removeEventListener("click", onOutsideStatusMenuClick, true);
    document.removeEventListener("scroll", onStatusMenuScroll, true);
    window.removeEventListener("resize", onStatusMenuScroll, true);
  }

  function onStatusMenuEsc(e){
    if (e.key === "Escape") closeStatusMenu();
  }
  function onOutsideStatusMenuClick(e){
    const m = document.getElementById("statusMenu");
    if (!m) return;
    if (m.contains(e.target)) return;
    closeStatusMenu();
  }

  function onStatusMenuScroll(e){
    const m = document.getElementById("statusMenu");
    if (!m) return;
    // If the user is scrolling INSIDE the menu (because it overflowed),
    // keep it open. Otherwise, close it.
    if (e && e.target && (e.target === m || m.contains(e.target))) return;
    closeStatusMenu();
  }


  function openStatusMenu(anchorEl, slug){
    closeStatusMenu();

    const p = ALL_PROJECTS.find(x => (x.slug||"") === slug);
    const current = p?.status || "Planning";

    const rect = anchorEl.getBoundingClientRect();
    const menu = document.createElement("div");
    menu.id = "statusMenu";
    menu.className = "status-menu";
    menu.innerHTML = `
      <h4>Update status</h4>
      <div class="row">
        <select id="statusSelect">
          ${STATUS_OPTIONS.map(s => `<option value="${s}" ${s===current ? "selected":""}>${s}</option>`).join("")}
        </select>
      </div>
      <div class="btnrow">
        <button class="btnx" type="button" id="statusCancel">Cancel</button>
        <button class="btnx primary" type="button" id="statusSave">Save</button>
      </div>
      
    `;

    // Position near the clicked pill, keep fully on-screen
const pad = 10;

// Start by placing below the anchor
let top = rect.bottom + 8;
let left = rect.left;

// Append first so we can measure the menu
document.body.appendChild(menu);
const mrect = menu.getBoundingClientRect();

// If it would overflow bottom, try above the anchor
if (top + mrect.height > window.innerHeight - pad){
  top = rect.top - mrect.height - 8;
}

// Clamp within viewport
top = Math.min(window.innerHeight - pad - mrect.height, Math.max(pad, top));
left = Math.min(window.innerWidth - pad - mrect.width, Math.max(pad, left));

menu.style.top = `${top}px`;
menu.style.left = `${left}px`;

    document.addEventListener("scroll", onStatusMenuScroll, true);
    window.addEventListener("resize", onStatusMenuScroll, true);

menu.querySelector("#statusCancel").addEventListener("click", closeStatusMenu);
    menu.querySelector("#statusSave").addEventListener("click", async () => {
      const sel = menu.querySelector("#statusSelect");
      const next = sel.value;
      try{
        sel.disabled = true;
        menu.querySelector("#statusSave").disabled = true;

        await updateStatusViaFunction(slug, next);

        // update local data + rerender
        const idx = ALL_PROJECTS.findIndex(x => (x.slug||"") === slug);
        if (idx >= 0) ALL_PROJECTS[idx].status = next;
        render(ALL_PROJECTS);
        closeStatusMenu();
      }catch(err){
        alert(`Status update failed: ${String(err?.message || err)}`);
        sel.disabled = false;
        menu.querySelector("#statusSave").disabled = false;
      }
    });

    document.addEventListener("keydown", onStatusMenuEsc, true);
    document.addEventListener("click", onOutsideStatusMenuClick, true);

    // focus select
    menu.querySelector("#statusSelect").focus();
  }

  // Make cards clickable (opens project in new tab when possible)
  // Card navigation handled by <a.card-open-link target=_blank> (no JS popups)
// Open status menu when clicking pill/edit icon
  grid.addEventListener("click", (e) => {
    const pill = e.target.closest('[data-action="status-menu"]');
    if (!pill) return;
    e.preventDefault();
    e.stopPropagation();
    const slug = pill.getAttribute("data-slug") || "";
    if (!slug) return;
    openStatusMenu(pill, slug);
  });


  // Dark mode preference
  (function initDark(){
    const saved = localStorage.getItem("mcm_dash_theme");
    if (saved === "dark") document.body.classList.add("dark");
    if (saved === "light") document.body.classList.remove("dark");

    const label = document.getElementById("darkLabel");
    const btn = document.getElementById("darkToggle");
    function syncLabel(){
      if (!label) return;
      label.textContent = document.body.classList.contains("dark") ? "Light" : "Dark";
    }
    syncLabel();

    if (!btn) return;

    btn.addEventListener("click", function(){
      document.body.classList.toggle("dark");
      localStorage.setItem("mcm_dash_theme", document.body.classList.contains("dark") ? "dark" : "light");
      syncLabel();
    });
  })();

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  function normalizeProject(slug, pj, registry){
    // Based on YOUR project.json structure :contentReference[oaicite:1]{index=1}
    const status = pj?.projectStatus || "Planning";
    const lastUpdate = pj?.lastUpdate || "";
    const insuranceStatus = pj?.insuranceStatus || "";
    const name = pj?.projectName || registry?.name || slug.replaceAll("-", " ");
    const projectAddress = pj?.projectAddress || "";

    const pinned = !!registry?.pinned;

    // city: from registry override OR parse from projectAddress
    const city = registry?.city || cityFromAddress(projectAddress);

    // progress: optional number in project.json; else derived by status
    const progress = progressPercent(pj ?? { projectStatus: status });

    return {
      slug,
      name,
      status,
      progress,
      lastUpdate,
      insuranceStatus,
      projectAddress,
      city,
      pinned
    };
  }

  async function loadAll(){
    loading.style.display = "block";
    errorBox.style.display = "none";
    errorBox.textContent = "";
    empty.style.display = "none";

    try{
      await loadStatusEngine();
      await initStatusOptions();
      const dash = await fetchJson(DASHBOARD_JSON_URL);
      ATTENTION_DAYS = Number(dash?.settings?.attentionDays ?? 14);

      
      if (typeof renderLegend === "function") renderLegend(dash?.legend);
const registryProjects = Array.isArray(dash?.projects) ? dash.projects : [];
      if (!registryProjects.length) throw new Error("dashboard.json has no projects array.");

      const registryBySlug = new Map(
        registryProjects.map(p => [String(p.slug||"").replace(/^\/+|\/+$/g,""), p])
      );
      const slugs = [...registryBySlug.keys()].filter(Boolean);

      const results = await Promise.allSettled(
        slugs.map(async (slug) => {
          const pj = await fetchJson(new URL(`${slug}/data/project.json?v=${Date.now()}`, PROJECTS_ROOT_URL).href);
          return normalizeProject(slug, pj, registryBySlug.get(slug));
        })
      );

      const projects = [];
      const failures = [];

      for (let i=0; i<results.length; i++){
        const r = results[i];
        const slug = slugs[i];

        if (r.status === "fulfilled"){
          projects.push(r.value);
        } else {
          failures.push(`${slug}/data/project.json`);
          // keep dashboard clean: skip rendering cards that failed to load
        }
      }

      const cleanProjects = projects.filter(Boolean);
      ALL_PROJECTS = cleanProjects;
      buildCityOptions(cleanProjects);
      render(cleanProjects);
      setLastRefresh(new Date());

      if (!window.__filtersBound){
        window.__filtersBound = true;
        const rerender = () => render(ALL_PROJECTS);
      setLastRefresh(new Date());
        q.addEventListener("input", rerender);
        statusSel.addEventListener("change", rerender);
        citySel.addEventListener("change", rerender);
      }

      if (failures.length){
        errorBox.style.display = "block";
        errorBox.innerHTML = `
          <strong>Missing data/project.json in:</strong><br>
          ${failures.map(f => esc(f)).join("<br>")}
        `;
      }

    }catch(err){
      console.error(err);
      empty.style.display = "block";
      empty.textContent = "Could not load dashboard.json or project.json files. Check deploy paths.";
      errorBox.style.display = "block";
      errorBox.textContent = String(err?.message || err);
    }finally{
      loading.style.display = "none";
      document.getElementById('refTime').textContent = new Date().toLocaleString();
  
  // ===== Weather gadget (Miami, FL) =====
  // Uses Open-Meteo (no API key). Change lat/lon if you want another city.
  const WEATHER = {
    lat: 25.7617,
    lon: -80.1918,
    tz: "America/New_York",
    cacheKey: "mcm_dash_weather_cache_v1",
    cacheTtlMs: 20 * 60 * 1000 // 20 min
  };

  function weatherCodeToText(code){
    const c = Number(code);
    if (isNaN(c)) return "—";
    if (c === 0) return "Clear";
    if (c === 1 || c === 2) return "Partly cloudy";
    if (c === 3) return "Overcast";
    if (c === 45 || c === 48) return "Fog";
    if (c === 51 || c === 53 || c === 55) return "Drizzle";
    if (c === 56 || c === 57) return "Freezing drizzle";
    if (c === 61 || c === 63 || c === 65) return "Rain";
    if (c === 66 || c === 67) return "Freezing rain";
    if (c === 71 || c === 73 || c === 75) return "Snow";
    if (c === 77) return "Snow grains";
    if (c === 80 || c === 81 || c === 82) return "Showers";
    if (c === 85 || c === 86) return "Snow showers";
    if (c === 95) return "Thunderstorm";
    if (c === 96 || c === 99) return "Storm + hail";
    return "Weather";
  }

  function setWeatherUI(tempF, code){
    const tEl = document.getElementById("weatherTemp");
    const dEl = document.getElementById("weatherDesc");
    if (!tEl || !dEl) return;
    const t = (typeof tempF === "number" && isFinite(tempF)) ? `${Math.round(tempF)}°F` : "—";
    tEl.textContent = t;
    dEl.textContent = weatherCodeToText(code);
  }

  async function loadWeather(){
    try{
      const now = Date.now();
      const cachedRaw = localStorage.getItem(WEATHER.cacheKey);
      if (cachedRaw){
        try{
          const cached = JSON.parse(cachedRaw);
          if (cached && (now - cached.ts) < WEATHER.cacheTtlMs){
            setWeatherUI(cached.tempF, cached.code);
            return;
          }
        }catch{}
      }

      const url = `https://api.open-meteo.com/v1/forecast?latitude=${WEATHER.lat}&longitude=${WEATHER.lon}&current=temperature_2m,weather_code&temperature_unit=fahrenheit&timezone=${encodeURIComponent(WEATHER.tz)}`;
      const res = await fetch(url, { cache: "no-store" });
      if (!res.ok) throw new Error(`Weather HTTP ${res.status}`);
      const data = await res.json();
      const tempF = data?.current?.temperature_2m;
      const code = data?.current?.weather_code;
      setWeatherUI(tempF, code);
      try{ localStorage.setItem(WEATHER.cacheKey, JSON.stringify({ ts: now, tempF, code })); }catch{}
    }catch(err){
      const dEl = document.getElementById("weatherDesc");
      if (dEl) dEl.textContent = "Weather unavailable";
    }
  }

  loadWeather();
  setInterval(loadWeather, WEATHER.cacheTtlMs);

    }
  }
  initLeadsUI();
  loadAll();
  // Load leads once dashboard is unlocked + projects loaded
  setTimeout(loadLeads, 250);

setInterval(() => {
  setLastRefresh(new Date());
}, 60000);
</script>


<script>
// Boot: always load project cards (read-only), even before unlock.
// Admin actions + Leads require unlock.
document.addEventListener("DOMContentLoaded", () => {
  try { loadAll(); } catch (e) { console.error(e); }
});
</script>

</body>
</html>
