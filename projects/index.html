<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Projects Dashboard | MCM Services</title>
  <meta name="robots" content="noindex, nofollow" />

  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@300;400;500;600;700&family=Playfair+Display:wght@400;700&display=swap" rel="stylesheet">

  <!-- Icons -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css">

  <!-- Favicons -->
  <link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png?v=3">
  <link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png?v=3">
  <link rel="icon" type="image/png" sizes="64x64" href="../favicon-64x64.png?v=3">
  <link rel="apple-touch-icon" href="../apple-touch-icon.png?v=3">
  <link rel="shortcut icon" href="../favicon.ico?v=3">

  <style>
    *, *::before, *::after { box-sizing: border-box; }

    :root{
      --bg:#F7F7F7;
      --card:#ffffff;
      --text:#333;
      --muted:#666;
      --muted2:#777;
      --border:#DDD;
      --border2:#EEE;
      --shadow: 0 4px 14px rgba(0,0,0,0.12);
      --shadow2: 0 10px 26px rgba(0,0,0,0.14);
      --gold:#C7A96B;
      --gold2:#b9965e;
      --header: rgba(0,0,0,0.4);
      --headerShadow: 0 5px 15px rgba(0,0,0,0.4);
      --barBg:#EFEFEF;
      --pillBg:#FAFAFA;
      --pillText:#222;
      --btnBg:#fff;
      --btnText:#222;
      --btnBorder: rgba(0,0,0,.10);
      --kpiHint:#777;
    }

    body.dark{
      --bg:#0d0f12;
      --card:#12161b;
      --text:#e9eef5;
      --muted:#aab3c0;
      --muted2:#9aa6b6;
      --border: rgba(255,255,255,0.10);
      --border2: rgba(255,255,255,0.08);
      --shadow: 0 10px 30px rgba(0,0,0,0.45);
      --shadow2: 0 16px 40px rgba(0,0,0,0.55);
      --header: rgba(0,0,0,0.55);
      --headerShadow: 0 14px 35px rgba(0,0,0,0.50);
      --barBg: rgba(255,255,255,0.10);
      --pillBg: rgba(255,255,255,0.06);
      --pillText:#e9eef5;
      --btnBg: rgba(255,255,255,0.04);
      --btnText:#e9eef5;
      --btnBorder: rgba(255,255,255,0.10);
      --kpiHint:#9aa6b6;
    }

    body{
      margin:0;
      font-family:'Montserrat',sans-serif;
      background:var(--bg);
      color:var(--text);
      overflow-x:hidden;
      line-height:1.6;
      text-align:left;
    }
    a{ text-decoration:none; color:inherit; }

    /* HEADER (logo centralizada, sem links) */
    header{
      width:100%;
      background:var(--header);
      box-shadow:var(--headerShadow);
      position:absolute;
      top:0; left:0;
      z-index:100;
      padding:25px;
      display:flex;
      justify-content:center;
      align-items:center;
    }
    .logo-link img{
      height:120px;
      max-width:320px;
      object-fit:contain;
    }

    main{
      min-height:80vh;
      padding:220px 20px 70px;
      display:block;
    }
    .wrap{
      max-width:1200px;
      margin:0 auto;
      width:100%;
    }

    h1{
      font-family:'Playfair Display',serif;
      color:var(--gold);
      font-weight:400;
      margin:0;
      font-size:3rem;
      margin-bottom:10px;
    }
    .sub{
      margin:0 0 18px;
      color:var(--muted);
      font-size:.95rem;
    }

    .top-actions{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
      margin: 10px 0 16px;
    }
    .badge-line{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      color:var(--muted2);
      font-size:.92rem;
    }
    .pill-mini{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--pillBg);
      color:var(--pillText);
      font-size:.86rem;
      font-weight:600;
    }
    .toggle{
      display:inline-flex;
      align-items:center;
      gap:10px;
      padding:10px 12px;
      border-radius:12px;
      border:1px solid var(--border);
      background:var(--btnBg);
      color:var(--btnText);
      box-shadow: 0 8px 18px rgba(0,0,0,0.10);
      cursor:pointer;
      user-select:none;
      font-weight:600;
      font-size:.92rem;
    }
    body.dark .toggle{ box-shadow: 0 14px 26px rgba(0,0,0,0.45); }
    .toggle i{ color:var(--gold); }

    .kpi-row{
      display:grid;
      grid-template-columns: repeat(4, minmax(0, 1fr));
      gap:14px;
      margin: 10px 0 16px;
    }
    @media (max-width: 980px){
      .kpi-row{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    .kpi{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:14px;
      padding:16px 16px 12px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .kpi::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:4px;
      background:var(--gold);
    }
    .kpi .label{
      font-size:.78rem;
      letter-spacing:.05em;
      color:var(--muted2);
      font-weight:700;
      text-transform:uppercase;
      margin-bottom:6px;
    }
    .kpi .value{
      font-size:1.55rem;
      font-weight:700;
      color:var(--text);
      line-height:1.1;
    }
    .kpi .hint{
      margin-top:6px;
      font-size:.86rem;
      color:var(--kpiHint);
    }

    .tools{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin: 8px 0 18px;
    }
    .tools-left{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .input, .select{
      height:42px;
      border:1px solid var(--border);
      border-radius:12px;
      padding:0 12px;
      outline:none;
      background:var(--card);
      color:var(--text);
      font-size:.95rem;
      box-shadow: 0 4px 14px rgba(0,0,0,0.08);
      min-width: 220px;
    }
    body.dark .input, body.dark .select{ box-shadow: 0 10px 26px rgba(0,0,0,0.45); }
    .select{ min-width:180px; text-align:center; }
    @media (max-width: 600px){
      .input, .select{ width:100%; min-width:unset; }
      .tools{ align-items:stretch; }
    }

    .section-row{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      margin: 10px 0 10px;
    }
    .section-title{
      font-size:1.25rem;
      color:var(--gold);
      font-family:'Playfair Display', serif;
    }

    .grid{
      display:grid;
      grid-template-columns: repeat(3, minmax(0, 1fr));
      gap:16px;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: repeat(2, minmax(0, 1fr)); }
    }
    @media (max-width: 620px){
      .grid{ grid-template-columns: 1fr; }
    }

    .card{
      background:var(--card);
      border:1px solid var(--border);
      border-radius:16px;
      padding:18px 18px 14px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
      transition:transform .2s ease, box-shadow .2s ease, border-color .2s ease;
    }
    .card::before{
      content:"";
      position:absolute;
      inset:0 0 auto 0;
      height:4px;
      background:var(--gold);
    }
    .card:hover{
      transform: translateY(-2px);
      box-shadow:var(--shadow2);
      border-color: rgba(199,169,107,.55);
    }

    .topline{
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap:12px;
      margin-bottom:10px;
    }
    .name{
      font-family:'Playfair Display',serif;
      color:var(--gold);
      font-size:1.45rem;
      font-weight:400;
      line-height:1.1;
      margin:0;
    }

    .right-stack{
      display:flex;
      flex-direction:column;
      align-items:flex-end;
      gap:8px;
    }

    .status-pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:var(--pillBg);
      font-size:.88rem;
      font-weight:600;
      white-space:nowrap;
      justify-content:flex-end;
      color:var(--pillText);
    }
    .dot{
      width:10px; height:10px;
      border-radius:50%;
      background:#1DB954;
      box-shadow:0 0 0 3px rgba(29,185,84,.14);
    }
    .dot.planning{ background:#F4B400; box-shadow:0 0 0 3px rgba(244,180,0,.16); }
    .dot.completed{ background:#2E7D32; box-shadow:0 0 0 3px rgba(46,125,50,.16); }
    .dot.onhold{ background:#999; box-shadow:0 0 0 3px rgba(153,153,153,.14); }

    .tag-row{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      justify-content:flex-end;
    }
    .tag{
      display:inline-flex;
      align-items:center;
      gap:7px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:transparent;
      color:var(--muted2);
      font-size:.82rem;
      font-weight:700;
      letter-spacing:.01em;
      white-space:nowrap;
    }
    .tag i{ color:var(--gold); }

    .tag.attn{
      border-color: rgba(244,180,0,.55);
      background: rgba(244,180,0,.10);
      color: var(--text);
    }
    .tag.pin{
      border-color: rgba(199,169,107,.60);
      background: rgba(199,169,107,.10);
      color: var(--text);
    }

    .meta{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 14px;
      margin-top:6px;
      padding-top:10px;
      border-top:1px solid var(--border2);
    }
    .meta-item{
      display:flex;
      flex-direction:column;
      gap:4px;
      min-width:0;
    }
    .meta-label{
      font-size:.75rem;
      letter-spacing:.05em;
      color:var(--muted2);
      font-weight:700;
      text-transform:uppercase;
    }
    .meta-value{
      font-size:.95rem;
      color:var(--text);
      font-weight:600;
      overflow:hidden;
      text-overflow:ellipsis;
      white-space:nowrap;
    }

    .progress{
      margin-top:12px;
      padding-top:12px;
      border-top:1px solid var(--border2);
    }
    .progress-row{
      display:flex;
      align-items:center;
      gap:12px;
    }
    .bar{
      flex:1;
      height:8px;
      border-radius:999px;
      background:var(--barBg);
      overflow:hidden;
    }
    .fill{
      height:100%;
      width:0%;
      border-radius:999px;
      background:linear-gradient(90deg,#d7b97a,#c8a76a);
      transition:width .5s ease;
    }
    .pct{
      min-width:44px;
      text-align:right;
      font-weight:700;
      color:var(--text);
      font-size:.92rem;
    }

    .actions{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:12px;
    }
    .btn{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:11px 14px;
      border-radius:12px;
      font-weight:600;
      font-size:.92rem;
      border:1px solid var(--btnBorder);
      background:var(--btnBg);
      color:var(--btnText);
      box-shadow: 0 8px 18px rgba(0,0,0,0.08);
      transition:transform .12s ease, box-shadow .12s ease, background-color .12s ease, border-color .12s ease;
    }
    body.dark .btn{ box-shadow: 0 14px 26px rgba(0,0,0,0.45); }
    .btn:hover{
      transform: translateY(-1px);
      box-shadow:0 12px 24px rgba(0,0,0,0.10);
      border-color: rgba(199,169,107,.55);
    }
    .btn.primary{
      background:var(--gold);
      border-color:var(--gold);
      color:#222;
    }
    .btn.primary:hover{ background:var(--gold2); color:#fff; }

    .loading, .empty, .error{
      margin-top:14px;
      padding:14px 16px;
      border-radius:14px;
      background:var(--card);
      color:var(--muted);
      border:1px solid var(--border);
      display:none;
    }
    .error{
      border-color: rgba(255,0,0,0.25);
      color: var(--text);
    }

    footer{
      background:white;
      padding:40px 20px;
      text-align:center;
      border-top:1px solid #DDD;
    }
    body.dark footer{
      background:#0b0d10;
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .footer-logo-container{
      display:block;
      margin:0 auto 15px;
      text-align:center;
    }
    .footer-logo-container img{
      height:60px;
      width:180px;
      object-fit:contain;
    }
    .footer-content-grid{
      max-width:1200px;
      margin:0 auto 30px;
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      text-align:left;
      gap:30px;
      flex-wrap:wrap;
    }
    .footer-col{
      display:flex;
      flex-direction:column;
      min-width:150px;
      padding:0 10px;
      align-items:flex-start;
    }
    .footer-col h4{
      font-size:1rem;
      font-weight:600;
      color:var(--text);
      margin-top:0;
      margin-bottom:15px;
      border-bottom:2px solid var(--gold);
      padding-bottom:5px;
      text-align:left;
    }
    .footer-col a{
      color:var(--muted);
      font-size:0.9rem;
      font-weight:400;
      padding:5px 0;
      transition:color 0.3s;
      display:block;
    }
    .footer-col a:hover{ color:var(--gold); }
    .footer-social-contact a{
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:10px;
      justify-content:center;
    }
    .footer-social-contact i{
      color:var(--gold);
      font-size:1rem;
    }
    .footer-bottom-line{
      padding-top:20px;
      border-top:1px solid rgba(0,0,0,0.06);
      color:var(--muted2);
      font-size:0.85rem;
      text-align:center;
    }
    body.dark .footer-bottom-line{
      border-top:1px solid rgba(255,255,255,0.08);
    }
    .footer-bottom-line p{ margin:5px 0; }
    .footer-bottom-line .copyright{
      font-size:0.9rem;
      color:var(--muted);
      line-height:1.6;
      letter-spacing:0.3px;
    }
    .footer-bottom-line strong{ font-weight:500; color:var(--text); }
    .powered-by{
      font-size:0.75rem;
      color:var(--muted2);
      letter-spacing:0.6px;
      display:inline-block;
      margin-top:4px;
    }
  
/* Legend */
.dashboard-legend{
  display:flex;
  gap:16px;
  flex-wrap:wrap;
  margin: 10px 0 18px;
  font-size: 13px;
  color: var(--muted);
}
.legend-item{
  display:flex;
  align-items:center;
  gap:8px;
  padding: 6px 10px;
  border: 1px solid var(--border);
  border-radius: 999px;
  background: var(--card);
  box-shadow: var(--shadow-sm);
}
.legend-dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
  display:inline-block;
}
.legend-item.planning .legend-dot{ background: #f59e0b; }
.legend-item.active .legend-dot{ background: #10b981; }
.legend-item.completed .legend-dot{ background: #3b82f6; }
.legend-item.hold .legend-dot{ background: #ef4444; }
</style>
</head>

<body>

<!-- BASIC PASSWORD (simple) -->
<script>
  
  function escapeHtml(s){return String(s).replace(/[&<>"\']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","\'":"&#39;" }[c]));}
function renderLegend(legend){
  const el = document.getElementById("legend");
  if (!el) return;

  const entries = legend && typeof legend === "object" ? Object.entries(legend) : [];
  const fallback = [
    ["Planning","Project in planning/approval"],
    ["Active","Work in progress"],
    ["Completed","Project completed"],
    ["On Hold","Paused / waiting"]
  ];
  const items = entries.length ? entries : fallback;

  const clsFor = (status) => {
    const s = String(status||"").toLowerCase();
    if (s.includes("hold")) return "hold";
    if (s.includes("complete")) return "completed";
    if (s.includes("active")) return "active";
    return "planning";
  };

  el.innerHTML = items.map(([k,v]) => {
    const cls = clsFor(k);
    const title = String(k||"").trim();
    const desc = String(v||"").trim();
    const tip = desc ? ` title="${escapeHtml(desc)}"` : "";
    return `<span class="legend-item ${cls}"${tip}><span class="legend-dot"></span>${escapeHtml(title)}</span>`;
  }).join("");
}

const DASH_PASSWORD = "mcm2026"; // <-- change here
  const access = prompt("Enter access password:");
  if (access !== DASH_PASSWORD) {
    document.body.innerHTML = `
      <div style="font-family:sans-serif;text-align:center;margin-top:120px;color:#111;">
        <h1>Access denied</h1>
        
<div id="legend" class="dashboard-legend" aria-label="Project status legend"></div>
<p>Incorrect password.</p>
      </div>
    `;
  }

setInterval(() => {
  setLastRefresh(new Date());
}, 60000);
</script>

<header>
  <a class="logo-link" href="../index.html">
    <img src="../images/FODA.png" alt="MCM Services Logo">
  </a>
</header>

<main>
  <div class="wrap">
    <h1>Projects Dashboard</h1>
    <p class="sub">Auto data from each <strong>project.json</strong>. One click opens the project portal.</p>

    <div class="top-actions">
      <div class="badge-line">
        <span class="pill-mini"><i class="fa-solid fa-bolt" aria-hidden="true" style="color:var(--gold)"></i> Auto from project.json</span>
        <span class="pill-mini"><i class="fa-solid fa-star" aria-hidden="true" style="color:var(--gold)"></i> Pinned</span>
        <span class="pill-mini"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true" style="color:#F4B400"></i> Needs Attention</span>
      </div>

      <button class="toggle" id="darkToggle" type="button" aria-label="Toggle dark mode">
        <i class="fa-solid fa-moon" aria-hidden="true"></i>
        <span id="darkLabel">Dark</span>
      </button>
    </div>

    <div class="kpi-row" aria-label="KPIs">
      <div class="kpi">
        <div class="label">Total</div>
        <div class="value" id="kpiTotal">0</div>
        <div class="hint">All projects in registry</div>
      </div>
      <div class="kpi">
        <div class="label">Active</div>
        <div class="value" id="kpiActive">0</div>
        <div class="hint">projectStatus = Active</div>
      </div>
      <div class="kpi">
        <div class="label">Completed</div>
        <div class="value" id="kpiCompleted">0</div>
        <div class="hint">projectStatus = Completed</div>
      </div>
      <div class="kpi">
        <div class="label">Needs Attention</div>
        <div class="value" id="kpiAttention">0</div>
        <div class="hint">Insurance not Active / old update</div>
      </div>
    </div>

    <div class="tools" aria-label="Tools">
      <div class="tools-left">
        <input id="q" class="input" type="search" placeholder="Search by name / slug..." autocomplete="off" />
        <select id="status" class="select" aria-label="Filter by status">
          <option value="all">All statuses</option>
          <option value="Planning">Planning</option>
          <option value="Active">Active</option>
          <option value="On Hold">On Hold</option>
          <option value="Completed">Completed</option>
        </select>
        <select id="city" class="select" aria-label="Filter by city/area">
          <option value="all">All areas</option>
        </select>
      </div>
    </div>

    <div class="section-row">
      <div class="section-title">Portfolio</div>
      <div style="color:var(--muted2); font-weight:600; font-size:.92rem;">
        Last refresh: <span id="refTime">—</span>
      </div>
    </div>

    <div id="loading" class="loading">Loading dashboard.json + project.json files...</div>
    <div id="error" class="error"></div>
    <section id="grid" class="grid" aria-label="Project cards"></section>
    <div id="empty" class="empty"></div>
  </div>
</main>

<footer>
  <div class="footer-logo-container">
    <img alt="MCM Services Logo Footer" src="../images/transparent-logo-2.png" />
  </div>

  <p style="color:var(--muted); font-size:.95rem; margin-bottom:15px;">
    Management Excellence, Flawless Execution.
  </p>

  <p style="color:var(--muted); font-size:.9rem; margin-bottom:30px;">
    <i class="fas fa-map-marker-alt" aria-hidden="true" style="color:var(--gold); margin-right:5px;"></i>
    Miami, FL
  </p>

  <div class="footer-content-grid">
    <div class="footer-col">
      <h4>Navigation</h4>
      <a href="../">Home</a>
      <a href="../#about">About</a>
      <a href="../#contact">Contact</a>
    </div>

    <div class="footer-col footer-social-contact">
      <h4>Contact &amp; Connect</h4>
      <a href="tel:+17862383386"><i class="fas fa-phone"></i> +1 (786) 238-3386</a>
      <a href="mailto:info@mcmprosolutions.com"><i class="fas fa-envelope"></i> info@mcmprosolutions.com</a>
      <a href="https://www.instagram.com/mcmservices.us" target="_blank" rel="noopener">
        <i class="fab fa-instagram"></i> @mcmservices.us
      </a>
    </div>

    <div class="footer-col">
      <h4>Legal</h4>
      <a href="../terms.html">Terms of Use</a>
      <a href="../privacy.html">Privacy Policy</a>
    </div>
  </div>

  <div class="footer-bottom-line">
    <p class="copyright">
      © <span id="year"></span>
      <strong>MCM Services USA Corporation</strong>. All rights reserved.<br />
      <span class="powered-by">Crafted &amp; Managed by mcmprosolutions.com</span>
    </p>
  </div>
</footer>

<script>
  document.getElementById('year').textContent = new Date().getFullYear();
  document.getElementById('refTime').textContent = new Date().toLocaleString();

  // CONFIG (FORCE ROOT)
const PROJECTS_ROOT = "/mcmservices/projects/"; // raiz real dos projetos
const DASHBOARD_JSON_URL = PROJECTS_ROOT + "dashboard.json";
const BASE_PROJECTS_URL = PROJECTS_ROOT; // mantém compatibilidade com usos existentes

  let ATTENTION_DAYS = 14;

  // UI
  const grid = document.getElementById("grid");
  const empty = document.getElementById("empty");
  const loading = document.getElementById("loading");
  const errorBox = document.getElementById("error");

  const q = document.getElementById("q");
  const statusSel = document.getElementById("status");
  const citySel = document.getElementById("city");

  function esc(s){
    return String(s ?? "")
      .replaceAll("&","&amp;")
      .replaceAll("<","&lt;")
      .replaceAll(">","&gt;")
      .replaceAll('"',"&quot;")
      .replaceAll("'","&#039;");
  }

  function dotClass(status){
    const s = (status||"").toLowerCase().trim();
    if (s === "completed") return "completed";
    if (s === "planning") return "planning";
    if (s === "on hold" || s === "onhold") return "onhold";
    return "";
  }

  function parseDateLoose(s){
    // Accept "Feb 04, 2026" and ignore placeholders like "MMM DD, YYYY"
    const str = String(s || "").trim();
    if (!str || str.toLowerCase().includes("mmm") || str.toLowerCase().includes("yyyy")) return null;
    const d = new Date(str);
    return isNaN(d.getTime()) ? null : d;
  }

  function daysAgo(dateObj){
    const now = new Date();
    const ms = now.getTime() - dateObj.getTime();
    return Math.floor(ms / (1000 * 60 * 60 * 24));
  }

  function statusToProgress(status){
    const s = (status||"").toLowerCase().trim();
    if (s === "completed") return 100;
    if (s === "active") return 40;
    if (s === "planning") return 10;
    if (s === "on hold" || s === "onhold") return 0;
    return 0;
  }

  function normalizeInsurance(s){
    return String(s || "").trim(); // "Active" | "Pending" | "Inactive" etc.
  }

  function needsAttention(p){
    const ins = (p.insuranceStatus || "").toLowerCase().trim();
    if (ins && ins !== "active") return true; // Pending/Inactive/etc => attention

    const isActive = (p.status || "").toLowerCase().trim() === "active";
    const d = parseDateLoose(p.lastUpdate || "");
    if (isActive){
      if (!d) return true; // Active but missing a real date
      return daysAgo(d) > ATTENTION_DAYS;
    }
    return false;
  }

  function cityFromAddress(addr){
    // "Street, City, State ZIP" => returns City
    const parts = String(addr || "").split(",").map(s => s.trim()).filter(Boolean);
    if (parts.length >= 2) return parts[parts.length - 2];
    return "";
  }

  function buildCityOptions(projects){
    const cities = Array.from(new Set(
      projects.map(p => (p.city || "").trim()).filter(Boolean)
    )).sort((a,b) => a.localeCompare(b));

    const current = citySel.value || "all";
    citySel.innerHTML =
      `<option value="all">All areas</option>` +
      cities.map(c => `<option value="${esc(c)}">${esc(c)}</option>`).join("");

    if ([...citySel.options].some(o => o.value === current)) citySel.value = current;
  }

  function kpis(projects){
    const total = projects.length;
    const active = projects.filter(p => p.status === "Active").length;
    const completed = projects.filter(p => p.status === "Completed").length;
    const attention = projects.filter(needsAttention).length;

    document.getElementById("kpiTotal").textContent = total;
    document.getElementById("kpiActive").textContent = active;
    document.getElementById("kpiCompleted").textContent = completed;
    document.getElementById("kpiAttention").textContent = attention;
  }

  function sortProjects(projects){
    const statusRank = (s) => {
      const x = (s||"").toLowerCase().trim();
      if (x === "active") return 1;
      if (x === "planning") return 2;
      if (x === "on hold" || x === "onhold") return 3;
      if (x === "completed") return 4;
      return 9;
    };

    return projects.slice().sort((a,b) => {
      const ap = !!a.pinned, bp = !!b.pinned;
      if (ap !== bp) return ap ? -1 : 1;

      const aa = needsAttention(a), ba = needsAttention(b);
      if (aa !== ba) return aa ? -1 : 1;

      const sr = statusRank(a.status) - statusRank(b.status);
      if (sr !== 0) return sr;

      return (a.name || "").localeCompare(b.name || "");
    });
  }

  function render(projects){
    const query = (q.value || "").trim().toLowerCase();
    const st = statusSel.value;
    const city = citySel.value;

    const filtered = sortProjects(projects).filter(p => {
      const matchQ = !query ||
        (p.name||"").toLowerCase().includes(query) ||
        (p.slug||"").toLowerCase().includes(query);

      const matchS = (st === "all") || (p.status === st);
      const matchC = (city === "all") || ((p.city||"") === city);

      return matchQ && matchS && matchC;
    });

    kpis(projects);

    grid.innerHTML = filtered.map(p => {
      const slug = String(p.slug || "").replace(/^\/+|\/+$/g, "");
      const projectUrl = `${BASE_PROJECTS_URL}${slug}/`;

      const pct = Math.max(0, Math.min(100, Number(p.progress ?? 0)));
      const dClass = dotClass(p.status);
      const attn = needsAttention(p);

      const attnReason = (() => {
        const ins = normalizeInsurance(p.insuranceStatus);
        if (ins && ins !== "Active") return `Insurance: ${ins}`;
        const d = parseDateLoose(p.lastUpdate || "");
        if ((p.status||"").toLowerCase().trim() === "active"){
          if (!d) return "Missing last update";
          const da = daysAgo(d);
          if (da > ATTENTION_DAYS) return `No update in ${da}d`;
        }
        return "";
      })();

      return `
        <article class="card">
          <div class="topline">
            <h3 class="name">${esc(p.name)}</h3>

            <div class="right-stack">
              <span class="status-pill">
                <span class="dot ${dClass}" aria-hidden="true"></span>
                ${esc(p.status)}
              </span>

              <div class="tag-row">
                ${p.pinned ? `<span class="tag pin"><i class="fa-solid fa-star" aria-hidden="true"></i> Pinned</span>` : ``}
                ${p.city ? `<span class="tag"><i class="fa-solid fa-location-dot" aria-hidden="true"></i> ${esc(p.city)}</span>` : ``}
                ${attn ? `<span class="tag attn"><i class="fa-solid fa-triangle-exclamation" aria-hidden="true"></i> Needs Attention</span>` : ``}
              </div>
            </div>
          </div>

          <div class="meta">
            <div class="meta-item">
              <span class="meta-label">Last update</span>
              <span class="meta-value">${esc(p.lastUpdate || "-")}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Insurance</span>
              <span class="meta-value">${esc(p.insuranceStatus || "—")}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Address</span>
              <span class="meta-value">${esc(p.projectAddress || "—")}</span>
            </div>
            <div class="meta-item">
              <span class="meta-label">Attention</span>
              <span class="meta-value">${esc(attn ? (attnReason || "Review") : "OK")}</span>
            </div>
          </div>

          <div class="progress">
            <div class="meta-label" style="margin-bottom:8px;">Progress</div>
            <div class="progress-row">
              <div class="bar"><div class="fill" style="width:${pct}%;"></div></div>
              <div class="pct">${pct}%</div>
            </div>
          </div>

          <div class="actions">
            <a class="btn primary" href="${projectUrl}">
              <i class="fa-solid fa-arrow-up-right-from-square" aria-hidden="true"></i>
              Open Project
            </a>
          </div>
        </article>
      `;
    }).join("");

    if (!filtered.length){
      empty.style.display = "block";
      empty.textContent = "No projects match your filters.";
    } else {
      empty.style.display = "none";
      empty.textContent = "";
    }
  }

  // Dark mode preference
  (function initDark(){
    const saved = localStorage.getItem("mcm_dash_theme");
    if (saved === "dark") document.body.classList.add("dark");
    if (saved === "light") document.body.classList.remove("dark");

    const label = document.getElementById("darkLabel");
    function syncLabel(){
      label.textContent = document.body.classList.contains("dark") ? "Light" : "Dark";
    }
    syncLabel();

    document.getElementById("darkToggle").addEventListener("click", function(){
      document.body.classList.toggle("dark");
      localStorage.setItem("mcm_dash_theme", document.body.classList.contains("dark") ? "dark" : "light");
      syncLabel();
    });
  })();

  async function fetchJson(url){
    const res = await fetch(url, { cache: "no-store" });
    if (!res.ok) throw new Error(`HTTP ${res.status} for ${url}`);
    return res.json();
  }

  function normalizeProject(slug, pj, registry){
    // Based on YOUR project.json structure :contentReference[oaicite:1]{index=1}
    const status = pj?.projectStatus || "Planning";
    const lastUpdate = pj?.lastUpdate || "";
    const insuranceStatus = pj?.insuranceStatus || "";
    const name = pj?.projectName || registry?.name || slug.replaceAll("-", " ");
    const projectAddress = pj?.projectAddress || "";

    const pinned = !!registry?.pinned;

    // city: from registry override OR parse from projectAddress
    const city = registry?.city || cityFromAddress(projectAddress);

    // progress: optional number in project.json; else derived by status
    const progress = (typeof pj?.progress === "number") ? pj.progress : statusToProgress(status);

    return {
      slug,
      name,
      status,
      progress,
      lastUpdate,
      insuranceStatus,
      projectAddress,
      city,
      pinned
    };
  }

  async function loadAll(){
    loading.style.display = "block";
    errorBox.style.display = "none";
    errorBox.textContent = "";
    empty.style.display = "none";

    try{
      const dash = await fetchJson(DASHBOARD_JSON_URL);
      ATTENTION_DAYS = Number(dash?.settings?.attentionDays ?? 14);

      
      if (typeof renderLegend === "function") renderLegend(dash?.legend);
const registryProjects = Array.isArray(dash?.projects) ? dash.projects : [];
      if (!registryProjects.length) throw new Error("dashboard.json has no projects array.");

      const registryBySlug = new Map(
        registryProjects.map(p => [String(p.slug||"").replace(/^\/+|\/+$/g,""), p])
      );
      const slugs = [...registryBySlug.keys()].filter(Boolean);

      const results = await Promise.allSettled(
        slugs.map(async (slug) => {
          const pj = await fetchJson(`${PROJECTS_ROOT}${slug}/data/project.json?v=${Date.now()}`);
          return normalizeProject(slug, pj, registryBySlug.get(slug));
        })
      );

      const projects = [];
      const failures = [];

      for (let i=0; i<results.length; i++){
        const r = results[i];
        const slug = slugs[i];

        if (r.status === "fulfilled"){
          projects.push(r.value);
        } else {
          failures.push(`${slug}/data/project.json`);
          // keep dashboard clean: skip rendering cards that failed to load
        }
      }

      const cleanProjects = projects.filter(Boolean);
      buildCityOptions(cleanProjects);
      render(cleanProjects);
      setLastRefresh(new Date());

      if (!window.__filtersBound){
        window.__filtersBound = true;
        const rerender = () => render(cleanProjects);
      setLastRefresh(new Date());
        q.addEventListener("input", rerender);
        statusSel.addEventListener("change", rerender);
        citySel.addEventListener("change", rerender);
      }

      if (failures.length){
        errorBox.style.display = "block";
        errorBox.innerHTML = `
          <strong>Missing data/project.json in:</strong><br>
          ${failures.map(f => esc(f)).join("<br>")}
        `;
      }

    }catch(err){
      console.error(err);
      empty.style.display = "block";
      empty.textContent = "Could not load dashboard.json or project.json files. Check deploy paths.";
      errorBox.style.display = "block";
      errorBox.textContent = String(err?.message || err);
    }finally{
      loading.style.display = "none";
      document.getElementById('refTime').textContent = new Date().toLocaleString();
    }
  }

  loadAll();

setInterval(() => {
  setLastRefresh(new Date());
}, 60000);
</script>

</body>
</html>
